name: Generate SBOM and Scan Vulnerabilities
on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 2 * * *'

jobs:
  sbom-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Process each service
        run: |
          services=$(cat .github/service-owners.json | jq -c '.services[]')

          for service in $services; do
            name=$(echo $service | jq -r '.name')
            path=$(echo $service | jq -r '.path')

            echo "Processing $name..."

            syft dir:$path \
              --name $name \
              --source-version $(git rev-parse --short HEAD) \
              -o cyclonedx-json > sbom-$name.json

            grype sbom:sbom-$name.json --fail-on critical -o json > vuln-$name.json || true
          done

      - name: Upload SBOM Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports-${{ github.sha }}
          path: sbom-*.json

      - name: Upload Vulnerability Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vuln-reports-${{ github.sha }}
          path: vuln-*.json

      - name: Commit SBOM files to Repository (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          mkdir -p sbom-latest
          cp sbom-*.json sbom-latest/

          git add sbom-latest/
          git diff --staged --quiet || git commit -m "Update SBOM files [skip ci]"
          git push

      - name: Create issues for critical vulnerabilities
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const services = JSON.parse(fs.readFileSync('.github/service-owners.json', 'utf8')).services;

            for (const service of services) {
              const vulnFile = `vuln-${service.name}.json`;
              if (fs.existsSync(vulnFile)) {
                const vulns = JSON.parse(fs.readFileSync(vulnFile, 'utf8'));
                const critical = vulns.matches?.filter(v => v.vulnerability.severity === 'Critical') || [];

                if (critical.length > 0) {
                  const issueBody = `**${critical.length} critical issues** in \`${service.name}\` found.\n\n` +
                    `**Details:**\n` +
                    critical.slice(0, 10).map(v =>
                      `- **${v.vulnerability.id}** in \`${v.artifact.name}@${v.artifact.version}\`\n` +
                      `  severity: ${v.vulnerability.severity}\n` +
                      `  ${v.vulnerability.description || 'no description'}`
                    ).join('\n\n');

                  const assignees = service.github_username && service.github_username.trim() !== ''
                    ? [service.github_username]
                    : [];

                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `critical weakness in ${service.name}`,
                    body: issueBody,
                    labels: ['security', 'critical', service.name],
                    assignees: assignees
                  });
                }
              }
            }
