name: Generate SBOM and Scan Vulnerabilities
# yaml
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'


jobs:
  sbom-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate combined SBOM
        run: |
          syft dir:. -o cyclonedx-json > sbom-combined.json

      - name: Scan for vulnerabilities
        run: |
          grype sbom:sbom-combined.json -o json > vuln-combined.json || true

      - name: Process individual services for issue creation
        run: |
          services=$(cat .github/service-owners.json | jq -c '.services[]')

          for service in $services; do
            name=$(echo $service | jq -r '.name')
            path=$(echo $service | jq -r '.path')

            echo "Processing $name..."

            syft dir:$path -o cyclonedx-json > sbom-$name.json
            grype sbom:sbom-$name.json -o json > vuln-$name.json || true
          done

      - name: Upload combined SBOM as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-combined-${{ github.sha }}
          path: sbom-combined.json

      - name: Upload combined Vulnerability Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vuln-combined-${{ github.sha }}
          path: vuln-combined.json

      - name: Upload individual service reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: service-reports-${{ github.sha }}
          path: |
            sbom-*.json
            vuln-*.json

      - name: Commit SBOM and Vulnerability Reports (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          mkdir -p reports-latest
          cp sbom-combined.json reports-latest/
          cp vuln-combined.json reports-latest/

          git add reports-latest/
          git diff --staged --quiet || git commit -m "Update SBOM and vulnerability reports [skip ci]"
          git push

      - name: Create issues for critical vulnerabilities
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const services = JSON.parse(fs.readFileSync('.github/service-owners.json', 'utf8')).services;

            for (const service of services) {
              const vulnFile = `vuln-${service.name}.json`;
              if (fs.existsSync(vulnFile)) {
                const vulns = JSON.parse(fs.readFileSync(vulnFile, 'utf8'));
                const critical = vulns.matches?.filter(v => v.vulnerability.severity === 'Critical') || [];

                if (critical.length > 0) {
                  const issueBody = `**${critical.length} critical vulnerabilities** found in \`${service.name}\`\n\n` +
                    `**Top vulnerabilities:**\n` +
                    critical.slice(0, 10).map(v =>
                      `- **${v.vulnerability.id}** in \`${v.artifact.name}@${v.artifact.version}\`\n` +
                      `  Severity: ${v.vulnerability.severity}\n` +
                      `  ${v.vulnerability.description || 'No description available'}\n` +
                      `  Fix: ${v.vulnerability.fix?.state || 'Unknown'}`
                    ).join('\n\n');

                  const assignees = service.github_username && service.github_username.trim() !== ''
                    ? [service.github_username]
                    : [];

                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `Critical vulnerabilities in ${service.name}`,
                    body: issueBody,
                    labels: ['security', 'critical', service.name],
                    assignees: assignees
                  });
                }
              }
            }
